% General
M = 4;
sampleRate = 1e6;
frameSize = 1000;

% Filter
rolloff = 0.50;
sps = 10;
span = 200;
rrcFilter = rcosdesign(rolloff, span, sps, "sqrt");

% Preamble
preamble1 = [1; 1; 1; 1; 1; 0; 0; 1; 1; 0; 1; 0; 1;]; % Barker code
preamble2 = [3; 3; 3; 3; 3; 2; 2; 3; 3; 2; 3; 2; 3;];
preamble = [preamble1; preamble2];

% Message
rng(1);
message = randi([0 M-1], frameSize, 1);

% Headers
headers = [[repmat(0, 3, 1); repmat(0, 3, 1)], ...
           [repmat(0, 3, 1); repmat(1, 3, 1)], ...
           [repmat(0, 3, 1); repmat(2, 3, 1)], ...
           [repmat(0, 3, 1); repmat(3, 3, 1)], ...
           [repmat(1, 3, 1); repmat(0, 3, 1)], ...
           [repmat(1, 3, 1); repmat(1, 3, 1)], ...
           [repmat(1, 3, 1); repmat(2, 3, 1)], ...
           [repmat(1, 3, 1); repmat(3, 3, 1)], ...
           [repmat(2, 3, 1); repmat(0, 3, 1)], ...
           [repmat(2, 3, 1); repmat(1, 3, 1)], ...
           [repmat(2, 3, 1); repmat(2, 3, 1)], ...
           [repmat(2, 3, 1); repmat(3, 3, 1)], ...
           [repmat(3, 3, 1); repmat(0, 3, 1)], ...
           [repmat(3, 3, 1); repmat(1, 3, 1)], ...
           [repmat(3, 3, 1); repmat(2, 3, 1)], ...
           [repmat(3, 3, 1); repmat(3, 3, 1)]];
header = headers(:, 1);

bitStream = [preamble; header; message];

preambleMod = pskmod(preamble, M, pi/M, "gray");
bitStreamMod = pskmod(bitStream, M, pi/M, "gray");
